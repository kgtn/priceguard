# План реализации PriceGuard Bot

## 1. Базовая инфраструктура
- [x] Реализация конфигурации (config.py)
- [x] Настройка базы данных (database.py)
- [x] Создание схемы базы данных
- [x] Настройка логирования

## 2. Ядро бота
- [x] Инициализация бота (main.py)
- [x] Базовая структура обработчиков
- [x] Система middleware для аутентификации
- [x] Обработка ошибок

## 3. Интеграция с маркетплейсами
- [x] Реализация Ozon API клиента
- [x] Реализация Wildberries API клиента
- [x] Шифрование API ключей
- [x] Валидация API ключей

## 4. Пользовательские команды
- [x] Команда /start
- [x] Команда /help
- [x] Команда /add_api
- [x] Команда /status
- [x] Команда /settings
- [x] Команда /unsubscribe
- [x] Команда /delete_data

## 5. Админские команды
- [x] Команда /admin
- [x] Команда /users
- [x] Команда /subscriptions
- [x] Команда /logs
- [x] Команда /broadcast
- [x] Команда /force_check

## 6. Система подписок и оплаты
- [x] Интеграция с YooKassa
- [x] Обработка платежей
- [x] Управление подписками
- [x] Автоматическое продление
- [x] Уведомления о статусе подписки

## 7. Мониторинг акций
- [x] Система периодических проверок
- [x] Сравнение изменений
- [x] Форматирование уведомлений
- [x] Отправка уведомлений пользователям

### Система очередей для API запросов
- [x] Реализация MarketplaceQueue для управления запросами
  - Отдельные очереди для Ozon и Wildberries
  - Лимит 30 запросов в минуту
  - Минимальный интервал 2 секунды между запросами
- [x] Интеграция с PromotionMonitor
  - Добавление проверок в соответствующие очереди
  - Обработка очередей для каждого маркетплейса
- [x] Оптимизация запуска бота
  - Предотвращение перегрузки API при старте
  - Приоритизация проверок по запросу пользователя
- [x] Обработка ошибок и повторные попытки
  - Обработка невалидных учетных данных
  - Механизм повторных попыток при ошибках API

### Улучшение архитектуры и надежности
- [ ] Рефакторинг управления состоянием
  - Создание класса ApplicationState
  - Улучшение инкапсуляции состояния приложения
  - Упрощение тестирования компонентов
- [ ] Улучшение системы обработки ошибок
  - Добавление специфических классов исключений
  - Внедрение retry-механизмов для критических операций
  - Улучшение логирования ошибок
  - Правильное завершение работы при сбоях

### Добавить запрос email для отправки чека
- [ ] Реализация запроса email у нового пользователя
- [ ] Реализация отправки чека на email после успешной оплаты

### Добавить кнопки для скачивания отчетов по акциям WB
1. Добавить метод `get_promo_products_list` в `WildberriesClient` для получения списка товаров в акции
   - Использовать эндпоинт `/api/v1/calendar/promotions/products`
   - Получать детальную информацию о товарах (артикул, название, цены, скидки)

2. Создать обработчик `send_wb_promo_report` в `user.py`
   - Добавить обработку callback-запросов для кнопок отчетов
   - Формировать CSV-файл с информацией о товарах
   - Отправлять файл пользователю

3. Обновить форматирование сообщений в `NotificationService`
   - Добавить кнопки для акций с товарами
   - Обновить метод `notify_promotion_changes` для поддержки клавиатур
   - Добавить форматирование кнопок в `_format_wb_changes`

Ожидаемый результат:
- Для каждой активной акции WB будет доступна кнопка скачивания отчета
- В отчете будет информация: артикул, название, обычная цена, цена со скидкой, размер скидки
- Отчет будет в формате CSV для удобного импорта

### Улучшить команду /logs для администратора

1. Изменить фильтрацию логов по времени:
   - Отправлять логи за последние 24 часа вместо последних 4000 символов
   - Анализировать временные метки в каждой строке лога
   - Добавить подсчет количества строк в отфильтрованных логах
   - Добавить информативные сообщения о количестве найденных строк

2. Добавить дополнительные опции:
   - Возможность выбора периода (24 часа, неделя, месяц)
   - Фильтрация по уровню логирования (ERROR, INFO, DEBUG)
   - Поиск по ключевым словам
   - Возможность объединения логов в один файл

Ожидаемый результат:
- Более удобный просмотр актуальных логов
- Гибкая фильтрация для поиска нужной информации
- Информативные сообщения о результатах фильтрации

## 8. Клавиатуры и UI
- [x] Главное меню
- [x] Меню настроек
- [x] Админ-панель
- [x] Интерактивные кнопки для управления подпиской

## 9. Тестирование и отладка
- [x] Базовое тестирование основных функций
- [x] Проверка обработки ошибок
- [x] Тестирование периодических задач
- [x] Проверка уведомлений

## 10. Документация
- [x] README.md
- [x] API документация
- [x] Руководство по разработке
- [x] История изменений




